# set-secret-workflow.yml

name: Get AWS info

on:
  workflow_call:
    # Map the workflow outputs to job outputs
    outputs:
      role_to_assume:
        description: "role_to_assume"
        value: ${{ jobs.job-get-aws-info.outputs.role_to_assume }}
      aws_region:
        description: "aws_region"
        value: ${{ jobs.job-get-aws-info.outputs.aws_region }}

jobs:
  job-get-aws-info:
    runs-on: ubuntu-latest
    outputs:
      role_to_assume: ${{steps.step-get-aws-info.outputs.role_to_assume}}
      aws_region: ${{steps.step-get-aws-info.outputs.aws_region}}
    steps:
      - uses: actions/checkout@v2  
      - name: Determine Environment and Set AWS Credentials
        id: step-get-aws-info 
        run: |
            if [[ ${{ github.ref }} == 'refs/heads/prod' ]]; then
              ENV_FILE="env_var/prod"            
            elif [[ ${{ github.ref }} == 'refs/heads/stage' ]]; then
              ENV_FILE="env_var/stage"
            else
              ENV_FILE="env_var/dev"
            fi
            # Read the variables from the selected environment file
            source $ENV_FILE
            # Export BUILD_ENV as an environment variable
            echo "BUILD_ENV=$BUILD_ENV" 
            aws_region=$AWS_REGION
            echo "AWS_REGION=$AWS_REGION" 
            role_to_assume=$ROLE_TO_ASSUME
            echo "ROLE_TO_ASSUME=$ROLE_TO_ASSUME" 

            echo "role_to_assume=$role_to_assume" >> $GITHUB_OUTPUT
            echo "aws_region=$aws_region" >> $GITHUB_OUTPUT
        shell: bash
